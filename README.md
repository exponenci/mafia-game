## TLDR

Результаты работы клиентов в `outs/core/` (название файла - юзернейм клиента; инпуты дублировались в ауты).

Для запуска всей системы:
``` docker-compose up -d --scale mafia-grpc-client=4 ```

Для остановки:
``` docker-compose down```

Результаты запуска появятся в `outs/core/`. Важно! Нужно подождать, пока завершится игра и появятся файлы (перед запуском клиентов, необходимо подождать warmup нашего `rabbitmq`).

---
## Основная логика

В игре 1 мафия, 1 комиссар, 2 жителя. Это можно настроить с помощью констант в коде.

В `outs/core/` можно будет найти вывод работы каждого клиента.
Код клиента расположен в `client/`:
 - `core.py` - реализует логику игры (сессии) для клиента. С помощью `test_helpers/input_simulator.py` случайным образом выбирает одно из доступных действий: 
    - `!help` - вывести доступные команды
    - `!tab` - вывести статистику сессии
    - `!status` - вывести статус клиента
    - `!pick <name>` - выбрать кого-то из представленных в списке
    - `!skip` - воздержаться от выбора
    - `!clear` - очистить терминал
    - `!new` - подключиться к очереди на новую сессию (доступно, только если клиент не в сессии)
    - `!exit` - отключиться (доступно, только если клиент не в сессии)
 - `grpc_stub.py` - реализует взаимодействие между Core-клиента и grpc-сервером. Он может регистрировать пользователя по юзернейму, отключать его, поставить его в очередь для сессии, слушать сообщения от сервера, классифицировать их (сессионные сообщения, например, новое состояние сессии; системные сообщения, например, о подключении игркоа) и выводить для клиента.
 - `main.py` - запускает клиента и подключает его к grpc-серверу по найденным в переменных окружения хосту и порту.
 - `test_helpers/run_client.py` - гененрирует имя пользователя, запускает `main.py` и сохраняет вывод в `outs/core`.

Код сервера расположен в `server/`.
 - `core.py` - основная логика игры. Следит за общесистемными состояниями сессий и клиентов (которые не относятся к состояниям клиента в сессии). Создает сессии при наборе достаточного числа участников в очереди.
 - `grpc_servicer.py` - Servicer для grpc-сервера, получает запросы от клиентов, в соответствии с которыми взаимодействует с Core-игры.
 - `main.py` - запускает сервер на найденном в переменных окружения порту.
 - `session.py` - распределяет роли, следит за игровым состоянем сессии и клиентов, создает сессионные сообщение по статусу сессии.

---
## Чат
Использовался `rabbitmq`. Сервер выдает клиентам уникальные для каждой сесси `routing_key` для их чатов (у мафии 2 таких `routing_key` - один для мафии, т.е. ночного общения, другой для дневного). Клиенты взаимодействуют с очередями `rabbitmq` с помощью этих ключей. После получения ключей, клиенты общаются между собой. Реализация чата в `client/async_chat.py`


---

## Прочее

В `draft/` лежит код сервера на Flask, реализующий простой API для чтения, записи, изменения, удаления данных игрока, которые хранятся в базе данных.